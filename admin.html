<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Panel</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Admin Quản lý</a>
        <div class="d-flex">
          <button class="btn btn-outline-light me-2" id="btn-go-user">
            Xem Dashboard User
          </button>
          <button class="btn btn-outline-light" id="btn-logout">
            Đăng xuất
          </button>
        </div>
      </div>
    </nav>

    <div class="container py-4">
      <!-- Form nhập tiền nhà (bills) -->
      <div class="card mb-4 shadow">
        <div class="card-body">
          <h5 class="card-title">Nhập thông tin tiền nhà</h5>
          <form id="form-bill">
            <div class="row">
              <div class="col-md-3 mb-3">
                <label class="form-label">Tiền nhà cứng</label>
                <input
                  type="number"
                  class="form-control"
                  id="input-house-fixed"
                  required
                />
              </div>
              <div class="col-md-3 mb-3">
                <label class="form-label">Số điện mới</label>
                <input
                  type="number"
                  class="form-control"
                  id="input-electric-new"
                  required
                />
              </div>
              <div class="col-md-3 mb-3">
                <label class="form-label">Số điện cũ</label>
                <input
                  type="number"
                  class="form-control"
                  id="input-electric-old"
                  required
                />
              </div>
              <div class="col-md-3 mb-3">
                <label class="form-label">Net & Rác</label>
                <input
                  type="number"
                  class="form-control"
                  id="input-net-trash"
                  required
                />
              </div>
            </div>
            <div class="row">
              <div class="col-md-3 mb-3">
                <label class="form-label">Số người ở</label>
                <input
                  type="number"
                  class="form-control"
                  id="input-people"
                  required
                />
              </div>
              <div class="col-md-3 mb-3">
                <label class="form-label">Tiền chủ nhà báo</label>
                <input
                  type="number"
                  class="form-control"
                  id="input-owner-sent"
                  required
                />
              </div>
            </div>
            <button type="submit" class="btn btn-primary">
              Lưu thông tin tiền nhà
            </button>
          </form>
        </div>
      </div>

      <!-- Biểu đồ & thống kê -->
      <div class="card mb-4 shadow">
        <div class="card-body">
          <h5 class="card-title">Biểu đồ nợ giữa các thành viên</h5>
          <canvas id="chart-overview" width="400" height="200"></canvas>
        </div>
      </div>

      <!-- Danh sách expenses pending để duyệt -->
      <div class="card mb-4 shadow">
        <div class="card-body">
          <h5 class="card-title">Các khoản chi chưa duyệt</h5>
          <div id="pending-list" class="list-group"></div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        getDocs,
        query,
        where,
        serverTimestamp,
        updateDoc,
        doc,
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyA-NnpxWJL8hW1-vyCpNi7fUtQsL4NbzSA",
        authDomain: "quanlychitieu-3ce52.firebaseapp.com",
        projectId: "quanlychitieu-3ce52",
        storageBucket: "quanlychitieu-3ce52.firebasestorage.app",
        messagingSenderId: "447902402830",
        appId: "1:447902402830:web:246f2c65982224240b2f5f",
      };

      const ADMIN_UID = "rVrRomrCGbPqPcrPddtBTpdcLoh2";
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      onAuthStateChanged(auth, (user) => {
        if (!user) {
          window.location.href = "index.html";
          return;
        }
        if (user.uid !== ADMIN_UID) {
          window.location.href = "dashboard.html";
          return;
        }
        // Nếu admin, hiển thị UI admin
      });

      document.getElementById("btn-logout").addEventListener("click", () => {
        signOut(auth).then(() => (window.location.href = "index.html"));
      });
      document.getElementById("btn-go-user").addEventListener("click", () => {
        window.location.href = "dashboard.html";
      });

      // Form bills submit
      document
        .getElementById("form-bill")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const houseFixed = Number(
            document.getElementById("input-house-fixed").value
          );
          const electricNew = Number(
            document.getElementById("input-electric-new").value
          );
          const electricOld = Number(
            document.getElementById("input-electric-old").value
          );
          const netTrash = Number(
            document.getElementById("input-net-trash").value
          );
          const people = Number(document.getElementById("input-people").value);
          const ownerSent = Number(
            document.getElementById("input-owner-sent").value
          );

          const electricity = (electricNew - electricOld) * 3800;
          const water = people * 100000;

          await addDoc(collection(db, "bills"), {
            houseFixed,
            electricity,
            netTrash,
            water,
            people,
            ownerSent,
            createdAt: serverTimestamp(),
          });

          alert("Đã lưu tiền nhà!");
          e.target.reset();
        });

      // Duyệt expense pending: hiển thị pending-list và nút approve/reject
      async function loadPending() {
        const q = query(
          collection(db, "expenses"),
          where("status", "==", "pending")
        );
        const snap = await getDocs(q);
        const listEl = document.getElementById("pending-list");
        listEl.innerHTML = "";
        snap.forEach((docSnap) => {
          const data = docSnap.data();
          const uid = docSnap.id;
          const item = document.createElement("div");
          item.className = "list-group-item";
          // lấy tên payer từ users collection
          // giả sử có userDoc
          const payer = data.payerUid;
          // fetch tên
          fetchUserName(payer).then((name) => {
            item.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong>${name}</strong> g proposed chi tiêu ${
              data.amount
            } VNĐ <br>
                "${data.description || ""}"
              </div>
              <div>
                <button class="btn btn-sm btn-success me-1" onclick="approve('${
                  docSnap.id
                }')">Duyệt</button>
                <button class="btn btn-sm btn-danger" onclick="reject('${
                  docSnap.id
                }')">Từ chối</button>
              </div>
            </div>
          `;
          });
          listEl.appendChild(item);
        });
      }

      async function approve(expId) {
        const docRef = doc(db, "expenses", expId);
        await updateDoc(docRef, { status: "approved" });
        loadPending();
      }
      async function reject(expId) {
        const docRef = doc(db, "expenses", expId);
        await updateDoc(docRef, { status: "rejected" });
        loadPending();
      }

      async function fetchUserName(uid) {
        const userDoc = await getDocs(
          query(collection(db, "users"), where("__name__", "==", uid))
        );
        // hoặc trực tiếp sử dụng doc(db, 'users', uid)
        const d = await getDocs(
          query(collection(db, "users"), where("uid", "==", uid))
        );
        // tùy data của bạn
        // giả sử bạn có users/{uid} với field displayName
        const userSnapshot = await getDocs(collection(db, "users"));
        // Tìm in list
        // (đơn giản mình làm fetch từng lần, bạn có thể tối ưu)
        const docRef = doc(db, "users", uid);
        const docSnap = await docRef.get();
        if (docSnap.exists()) {
          return docSnap.data().displayName || uid;
        } else {
          return uid;
        }
      }

      // load biểu đồ và pending ở init
      loadPending();
      // load biểu đồ giống mẫu trước
    </script>
  </body>
</html>
