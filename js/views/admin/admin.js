function fmt(v){return (Number(v)||0).toLocaleString('vi-VN')+' đ'}
async function loadPending(){const db=firebase.firestore();const s=await db.collection('iouRequests').where('status','==','pending').orderBy('createdAt','desc').limit(50).get();const items=s.docs.map(d=>({id:d.id,...d.data()}));const tb=document.getElementById('pendingTbody');if(!tb)return;tb.innerHTML=items.map(r=>`<tr data-id="${r.id}"><td>${r.createdAt?.toDate?r.createdAt.toDate().toISOString().slice(0,16).replace('T',' '):'—'}</td><td>${r.description||'—'}</td><td>${r.payer?.name||'—'}</td><td>${r.requesterName||'—'}</td><td class="text-end">${fmt(r.amount)}</td><td><button class="btn btn-success btn-sm btn-approve">Duyệt</button> <button class="btn btn-outline-danger btn-sm btn-reject">Từ chối</button></td></tr>`).join('')||`<tr><td colspan="6" class="text-muted">Không có pending.</td></tr>`}
async function approve(id){const db=firebase.firestore();const ref=db.collection('iouRequests').doc(id);const doc=await ref.get();if(!doc.exists)return alert('Không tìm thấy yêu cầu.');const r=doc.data();const parts=Array.isArray(r.participants)?r.participants:[];if(!parts.length)return alert('Không có người tham gia');const each=Math.round((+r.amount||0)/parts.length);const batch=db.batch();const now=firebase.firestore.FieldValue.serverTimestamp();parts.forEach(p=>{const dref=db.collection('debts').doc();batch.set(dref,{userId:p.uid,title:r.description||'Chi tiêu',kind:'Chi tiêu',creditor:r.payer?.name||'—',amount:each,status:'unpaid',createdAt:now})});batch.update(ref,{status:'approved',approvedAt:now});await batch.commit();await loadPending();alert('Đã duyệt & tạo nợ.')}
async function reject(id){const db=firebase.firestore();await db.collection('iouRequests').doc(id).update({status:'rejected',rejectedAt:firebase.firestore.FieldValue.serverTimestamp()});await loadPending();alert('Đã từ chối.')}
export function init(){document.getElementById('btnLogout')?.addEventListener('click',async()=>{await firebase.auth().signOut();window.navigate('/login')});const tb=document.getElementById('pendingTbody');tb?.addEventListener('click',e=>{const tr=e.target.closest('tr[data-id]');if(!tr)return;const id=tr.getAttribute('data-id');if(e.target.classList.contains('btn-approve'))approve(id).catch(alert);if(e.target.classList.contains('btn-reject'))reject(id).catch(alert)});loadPending().catch(console.warn)}
