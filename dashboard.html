<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard Người Dùng</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Chi tiêu phòng</a>
        <div class="d-flex">
          <span class="navbar-text me-3" id="greeting">Xin chào</span>
          <button class="btn btn-outline-light" id="btn-logout">
            Đăng xuất
          </button>
        </div>
      </div>
    </nav>

    <div class="container py-4">
      <!-- Form thêm khoản chi -->
      <div class="card mb-4 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Thêm khoản chi mới</h5>
          <form id="form-expense">
            <div class="mb-3">
              <label for="input-amount" class="form-label">Số tiền</label>
              <input
                type="number"
                class="form-control"
                id="input-amount"
                required
              />
            </div>
            <div class="mb-3">
              <label class="form-label">Chia đều hay tùy chỉnh</label>
              <select class="form-select" id="input-split-type">
                <option value="equal">Chia đều</option>
                <option value="custom">Tùy chỉnh</option>
              </select>
            </div>
            <div class="mb-3" id="custom-split-container" style="display: none">
              <!-- số người chia & input từng người -->
              <label class="form-label">Chi tiết chia</label>
              <div id="custom-split-fields">
                <!-- JS sẽ render input cho mỗi thành viên -->
              </div>
            </div>
            <div class="mb-3">
              <label for="input-description" class="form-label">Mô tả</label>
              <input type="text" class="form-control" id="input-description" />
            </div>
            <button type="submit" class="btn btn-success">Gửi</button>
          </form>
        </div>
      </div>

      <!-- Thông tin nợ -->
      <div class="card mb-4 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Tình trạng nợ</h5>
          <p>Bạn đang nợ: <strong id="you-owe">0 VNĐ</strong></p>
          <p>Người khác nợ bạn: <strong id="others-owe">0 VNĐ</strong></p>
        </div>
      </div>

      <!-- Danh sách các khoản chi -->
      <div class="row">
        <div class="col-md-6 mb-4">
          <div class="card shadow-sm">
            <div class="card-header">Các khoản bạn đã trả</div>
            <div class="card-body" id="your-expenses-list"></div>
          </div>
        </div>
        <div class="col-md-6 mb-4">
          <div class="card shadow-sm">
            <div class="card-header">Các khoản bạn nợ người khác</div>
            <div class="card-body" id="shared-to-you-list"></div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
      // giống logic Firebase + auth như trước, thêm phần xử lý form submit
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        serverTimestamp,
        query,
        where,
        getDocs,
        orderBy,
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyA-NnpxWJL8hW1-vyCpNi7fUtQsL4NbzSA",
        authDomain: "quanlychitieu-3ce52.firebaseapp.com",
        projectId: "quanlychitieu-3ce52",
        storageBucket: "quanlychitieu-3ce52.firebasestorage.app",
        messagingSenderId: "447902402830",
        appId: "1:447902402830:web:246f2c65982224240b2f5f",
      };

      const ADMIN_UID = "rVrRomrCGbPqPcrPddtBTpdcLoh2";
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      onAuthStateChanged(auth, (user) => {
        if (!user) {
          window.location.href = "index.html";
          return;
        }
        if (user.uid === ADMIN_UID) {
          window.location.href = "admin.html";
          return;
        }
        document.getElementById("greeting").textContent =
          "Xin chào, " + (user.displayName || user.email);
        setupForm();
        loadUserDashboard(user.uid);
      });

      document.getElementById("btn-logout").addEventListener("click", () => {
        signOut(auth).then(() => {
          window.location.href = "index.html";
        });
      });

      function setupForm() {
        const splitType = document.getElementById("input-split-type");
        const customContainer = document.getElementById(
          "custom-split-container"
        );

        splitType.addEventListener("change", () => {
          if (splitType.value === "custom") {
            customContainer.style.display = "block";
            // render custom fields, giả sử bạn biết danh sách member trong room
          } else {
            customContainer.style.display = "none";
          }
        });

        const form = document.getElementById("form-expense");
        form.addEventListener("submit", async (event) => {
          event.preventDefault();
          const amount = Number(document.getElementById("input-amount").value);
          const splitTypeValue =
            document.getElementById("input-split-type").value;
          const description =
            document.getElementById("input-description").value;
          const payerUid = auth.currentUser.uid;
          const createdAt = serverTimestamp();

          // xác định shareDetail
          let shareDetail = {};
          // giả sử bạn có mảng userList chứa các member {uid, displayName}
          // nếu equal: chia đều
          // nếu custom: lấy từ các input custom

          // Example mẫu:
          const userList = []; // TODO: load từ Firestore users trong room
          if (splitTypeValue === "equal") {
            const num = userList.length;
            const per = Math.floor(amount / num);
            userList.forEach((u) => {
              shareDetail[u.uid] = per;
            });
          } else {
            // custom xử lý nhập từng người
          }

          await addDoc(collection(db, "expenses"), {
            payerUid,
            amount,
            description,
            shareDetail,
            status: "pending",
            createdAt,
          });

          alert("Gửi khoản chi, chờ admin duyệt.");
          form.reset();
          document.getElementById("custom-split-container").style.display =
            "none";
          // reload list hoặc cập nhật
        });
      }

      async function loadUserDashboard(uid) {
        // logic như trước, dùng displayName thay cho uid
        // bạn cần load users collection để lấy tên theo uid
      }
    </script>
  </body>
</html>
